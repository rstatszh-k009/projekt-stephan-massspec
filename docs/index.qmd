---
title: "index"
format: html
editor: visual
author: "Stephan Walker"
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(gt)
```

```{r}
# read_csv2 für ";" geteilte Tabelle
cortison_import <- read_csv2(here::here("daten/raw/Cortison_csv.csv"))
hydrocortison_import <- read_csv2(here::here("daten/raw/Hydrocortison_csv.csv"))
```

# Einleitung

Im Rahmen des Nationalen Fremdstoffuntersuchungs Programm (NFUP) wurden in Proben von tierischen Lebensmitteln die Rückstände von Cortison und Hydrocortison gemessen. Beide Substanzen kommen natürlich in Produkten tierischer Herkunft vor. Für die Substanzen gibt es abgesehen von Milch keine Grenzwerte oder sonstige Beurteilungskriterien.

## Daten

Resultate der im Rahmen des NFUP durchgeführten Messungen durch die Abteilung Tierarzneimittel Analytik des Kantonalen Labors Zürich.

## Analyseziele

Es soll gezeigt werden wie sich die Konzentrationen von Cortison und Hydrocortison in den mehr als 2000 Messungen verteilen.

Gibt es Unterschiede zwischen einzelnen Matrizes? z.B Muskel und Leber

Gibt es Unterschiede zwischen verschiedenen Tierarten? z.B. Rinder und Schweine

# Datenaufbereitung

Daten zusammenführen und Spaltentitel ändern

```{r}
# merge mit all = TRUE um auch Proben mit nur einem Resultat in der Tabelle zu behalten
data_merge <- merge(cortison_import, hydrocortison_import, by="ProbenID", all = TRUE)

# Konzentrationen als Zahl(numeric)
data_numeric <- mutate(data_merge,
                           cortison_conc = as.numeric(ResultatResultat.x)) |> 
                  mutate(data_merge,
                           hydrocortison_conc = as.numeric(ResultatResultat.y))

# ware und datum in einer Spalte auch wenn nur ein Wert gefunden                 
data_ware <- data_numeric |> 
  mutate(ware = case_when(
    ProbeWare.y == NA ~ ProbeWare.x,
    .default = ProbeWare.y
  ))

# ware aufräumen
data_ware_clean <- data_ware |> 
  mutate(ware = case_when(
    ware == "Schwein - D\xe4rme" ~ "Schwein - Darm",
    ware == "Kuh - But" ~ "Kuh - Blut",
    ware == "Blut - Kuh" ~ "Kuh - Blut",
    ware == "Blut - Kalb" ~ "Kuh - Blut",
    ware == "Kalb- Blut" ~ "Kalb - Blut",
    ware == "Fisch -Muskel" ~ "Fisch - Muskel",
    ware == "Damhirsch - Muskel" ~ "Zuchtwild - Muskel",
    ware == "Gehege- oder Zuchtschalenwild - Leber" ~ "Zuchtwild - Leber",
    ware == "Kalb -  Blut" ~ "Kalb - Blut", # zwei leerschläge!
    ware == "Kalb-Blut" ~ "Kalb - Blut",
    ware == "Kalb- Muskel" ~ "Kalb - Muskel",
    ware == "Kalbsfleisch" ~ "Kalb - Muskel",
    ware == "Kalb - Urin" ~ "Kalb - Harn",
    ware == "Kuh - Urin" ~ "Kuh - Harn",
    ware == "Kalb- Leber" ~ "Kalb - Leber",
    ware == "Kuh -Blut" ~ "Kuh - Blut",
    ware == "Kuh- Blut" ~ "Kuh - Blut",
    ware == "Kuh-Blut" ~ "Kuh - Blut",
    ware == "Kuh- Leber" ~ "Kuh - Leber",
    ware == "Kuh- Muskel" ~ "Kuh - Muskel",
    ware == "Milchkuh - Blut" ~ "Kuh - Blut",
    ware == "Rind - Kalb - Kuh - Muskel" ~ "Rind - Muskel",
    ware == "Rind / Kalb / Kuh - Blut" ~ "Rind - Blut",
    ware == "Rind / Kalb / Kuh - Harn" ~ "Rind - Harn",
    ware == "Rind / Kalb / Kuh - Leber" ~ "Rind - Leber",
    ware == "Rind / Kalb / Kuh - Urin" ~ "Rind - Harn",
    ware == "Rind Kalb Kuh  - Leber" ~ "Rind - Leber",
    ware == "Rind Kalb Kuh - Leber" ~ "Rind - Leber",
    ware == "Rind - Urin" ~ "Rind - Harn",
    ware == "Rind- Blut" ~ "Rind - Blut",
    ware == "Rind -Blut" ~ "Rind - Blut",
    ware == "Rind- Leber" ~ "Rind - Leber",
    ware == "Rind- Muskel" ~ "Rind - Muskel",
    ware == "Rind-Blut" ~ "Rind - Blut",
    ware == "Rind/Kalb/Kuh - Blut" ~ "Rind - Blut",
    ware == "Rind / Kalb / Kuh - Harn" ~ "Rind - Harn",
    ware == "Rind / Kalb / Kuh - Leber" ~ "Rind - Leber",
    ware == "Rind / Kalb / Kuh - Urin" ~ "Rind - Harn",
    ware == "Rind/Kalb/Kuh - Harn" ~ "Rind - Harn",
    ware == "Rind/Kalb/Kuh - Leber" ~ "Rind - Leber",
    ware == "Rind/Kalb/Kuh - Muskel" ~ "Rind - Muskel",
    ware == "Rind/Kalb/Kuh - Niere" ~ "Rind - Niere",
    ware == "Rind/Kalb/Kuh - Plasma" ~ "Rind - Plasma",
    ware == "Rind/Kalb/Kuh- Blut" ~ "Rind - Blut",
    ware == "Schafe - Leber" ~ "Schaf - Leber",
    ware == "Schafe - Muskel" ~ "Schaf - Muskel",
    ware == "Schafe - Niere" ~ "Schaf - Niere",
    ware == "Schweine - Muskel" ~ "Schwein - Muskel",
    ware == "Stier - Blut" ~ "Rind - Blut",
    ware == "Stier - Harn" ~ "Rind - Harn",
    ware == "Ziegen - Leber" ~ "Ziege - Leber",
    ware == "Ziegen - Muskel" ~ "Ziege - Muskel",
    ware == "Muni - Harn" ~ "Rind - Harn",
    ware == "Muni - Leber" ~ "Rind - Leber",
    ware == "Muni - Muskel" ~ "Rind - Muskel",
    ware == "Ochs - Harn" ~ "Rind - Harn",
    ware == "Ochs - Muskel" ~ "Rind - Muskel",
    ware == "Ochse - Harn" ~ "Rind - Harn",
    ware == "Ochse - Leber" ~ "Rind - Leber",
    .default = ware
  ))
  
data_ware |> 
  count(ware)

data_ware_clean |> 
  count(ware)
# ware trennen in tierart und matrix
data_matrix_tierart <- data_ware_clean |> 
  separate(ware, c("tierart","matrix"))

data_matrix_tierart |> 
  count(matrix)

data_matrix_tierart |> 
  count(tierart)
                
# datum zusammenfassen

data_matrix_tierart_datum <- data_matrix_tierart |> 
  mutate(datum = case_when(
    ProbeErhebungsdatum.x == is.character(ProbeErhebungsdatum.x) ~ ProbeErhebungsdatum.x,
    .default = ProbeErhebungsdatum.y
  ))

# datum aufräumen

data_matrix_tierart_datum_clean <- data_matrix_tierart_datum |> 
  mutate(datum = case_when(
    datum == "25.10.0202 00:00:00" ~ "25.10.2021",
    .default = datum
  ))

data_matrix_tierart_datum_clean |> 
  count(datum)

# Datum formatieren
data_matrix_tierart_date <- data_matrix_tierart_datum_clean |> 
  mutate(datum = as_date(datum, format = "%d.%m.%Y"))


data_matrix_tierart_date |> 
  count(datum)

data_matrix_tierart_date |> 
  glimpse()

# Methode in einer Spalte

data_matrix_tierart_date_meth <- data_matrix_tierart_date |> 
  mutate(methode = case_when(
    ResultatMethodencode.x == is.character(ResultatMethodencode.x) ~ ResultatMethodencode.x,
    .default = ResultatMethodencode.y
  ))

data_matrix_tierart_date_meth |> 
  count(methode)

data_matrix_tierart_date_methnr <- data_matrix_tierart_date_meth |> 
  mutate(methode = case_when(
    methode == "Z4044" ~ "EtAc",
    methode == "Z4050" ~ "ACN",
    .default = methode
  ))

data_matrix_tierart_date_methnr |> 
  count(methode)

data_matrix_tierart_date_methnr |> 
  glimpse()
```

summarize

```{r}
cortison_tidy <- data_matrix_tierart_date_methnr |> 
  group_by(ProbenID,cortison_conc,hydrocortison_conc,tierart,matrix,datum,methode) |> 
  summarise()

cortison_tidy |> 
  gt()
```

exportieren

```{r}
write_csv(x = cortison_tidy,
          "daten/processed/cortison_tidy.csv")
```

Datum formatieren

```{r}
cortison_datum3 <- mutate(cortison_matrix2, monat = month(datum_date))
jahreszeiten <- c("Frühling","Sommer","Herbst","Winter")
cortison_datum4 <- mutate(cortison_datum3,
                          jahreszeit = case_when(
                            monat == c(3,4,5) ~ "Frühling",
                            monat == c(6,7,8) ~ "Sommer",
                            monat == c(9,10,11) ~ "Herbst",
                            monat == c(1,2,12) ~ "Winter"
                          ))



cortison_datum4 |> 
  count(matrix)

cortison_datum4 |> 
  count(matrix)
```

Untergruppen erstellen

```{r}
leber <- filter(cortison_datum3, matrix == "Leber")
niere <- filter(cortison_datum3, matrix == "Niere")
muskel <- filter(cortison_datum3, matrix == "Muskel")
```

Daten überprüfen

```{r}

```

# Daten Visualisierung

```{r}
ggplot(data = cortison_datum3,
       mapping = aes(x = matrix,
                     y = cortison_conc
                    
                     ))+
  geom_boxplot()

```

Nach Tierart

```{r}
ggplot(data = muskel,
       mapping = aes(x = cortison_conc,
                     y = hydrocortison_conc,
                     color = tierart))+
  geom_point()
```

Tabelle Muskel

```{r}
group_by(muskel, tierart) |> 
  summarise(n(),
            mean(cortison_conc), 
            min(cortison_conc), 
            max(cortison_conc), 
            mean(hydrocortison_conc),
            min(hydrocortison_conc),
            max(hydrocortison_conc))
```
